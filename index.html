<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è†³é£Ÿè¥å…»è¿½è¸ªå¹³å° V4.4</title>
    <style>
/* ===== Minecraft UI Cartoon Pixel Style ===== */
body {
    font-family: 'Segoe UI', 'å¾®è½¯é›…é»‘', 'Arial', sans-serif;
    background: repeating-linear-gradient(135deg, #90c272 0 40px, #b5dca6 40px 80px, #7fc4c6 80px 120px, #bcdcff 120px 160px);
    min-height: 100vh;
    color: #343421;
    padding: min(2vw, 32px);
}

/* æ–¹å—ç«‹ä½“æ„Ÿå¤§è¾¹æ¡†å’Œé˜´å½± */
.interface, .data-page {
    background: #e3e3e3;
    border: 4px solid #639643;
    border-radius: 0;
    box-shadow: 8px 8px 0 #b39a69, 0 8px 32px 0 #8fc87733;
    padding: min(5vw, 40px) min(5vw, 44px) min(4vw, 32px) min(5vw, 44px);
    margin-bottom: 20px;
    transition: box-shadow 0.18s;
    width: 100%;
    box-sizing: border-box;
}

.main-page {
    background: none;
    border: none;
    box-shadow: none;
    padding: 0;
}

.app-header {
    background: #a6d08c;
    border: 4px solid #639643;
    border-bottom: none;
    box-shadow: 0 6px 0 #b39a69;
    padding: 10px 24px 10px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #2e5714;
    border-radius: 0;
    font-family: 'Segoe UI', 'å¾®è½¯é›…é»‘', sans-serif;
}

.title {
    font-size: 2.2rem;
    font-weight: 700;
    letter-spacing: 2px;
    color: #397d1c;
    text-shadow: 2px 2px 0 #b6e69b, 4px 4px 0 #fff4a3;
    font-family: inherit;
}

/* åƒç´ ç«‹ä½“æŒ‰é’® */
.icon-btn {
    width: 44px; height: 44px; 
    border: 3px solid #397d1c;
    background: #6ad64d;
    color: #fff4a3;
    font-size: 24px; cursor: pointer;
    display: inline-flex; align-items: center; justify-content: center;
    margin-left: 6px; margin-right: 0;
    box-shadow: 3px 3px 0 #b39a69, 0 0 0 #fff4a3;
    border-radius: 0; /* æ–¹å— */
    transition: background 0.12s, color 0.15s, box-shadow 0.12s;
}
.icon-btn:hover {
    background: #fff4a3;
    color: #639643;
    box-shadow: 1px 1px 0 #b39a69, 2px 2px 0 #fff4a3;
}

/* èœå•ä¸‹æ‹‰ä¹Ÿæœ‰æ–¹å—é£æ ¼ */
.nav-content {
    background: #d6ffd2;
    border: 3px solid #639643;
    box-shadow: 4px 4px 0 #b39a69;
    border-radius: 0;
    top: 44px;
    min-width: 128px;
}
.nav-content a {
    color: #397d1c;
    font-size: 17px;
    padding: 14px 18px;
    border-bottom: 2px dashed #b39a69;
    font-weight: 600;
    text-decoration: none;
    display: block;
    font-family: inherit;
    background: transparent;
    letter-spacing: 1px;
    transition: background 0.12s, color 0.12s;
}
.nav-content a:hover {
    background: #fff4a3;
    color: #397d1c;
}

/* è¾“å…¥æ¡†ä¹Ÿæ”¹æˆç²—è¾¹åƒç´ é£ */
input, select, textarea {
    background: #f5f5d7;
    color: #2d3a0a;
    border: 2.5px solid #397d1c;
    border-radius: 0;
    font-family: inherit;
    font-size: 15px;
    box-shadow: 2px 2px 0 #b39a69;
    padding: 9px 10px;
    margin-bottom: 4px;
    outline: none;
    transition: border 0.14s, box-shadow 0.16s;
    width: 100%;
    min-width: 0;
    max-width: 100%;
    box-sizing: border-box;
}
input:focus, select:focus, textarea:focus {
    border-color: #6ad64d;
    background: #fff4a3;
    box-shadow: 0 0 0 3px #e1ffc7;
}

.btn {
    background: #6ad64d;
    color: #343421;
    border: 3px solid #397d1c;
    border-radius: 0;
    font-size: 15px;
    font-weight: 700;
    box-shadow: 2px 2px 0 #b39a69;
    transition: background 0.13s, color 0.14s, box-shadow 0.12s;
    margin-top: 12px;
    text-transform: none;
    letter-spacing: 1px;
    padding: 12px 0;
}
.btn:hover {
    background: #fff4a3;
    color: #639643;
    box-shadow: 1px 1px 0 #b39a69;
}

.interface-title {
    font-size: 1.18rem;
    font-weight: 900;
    color: #397d1c;
    border-bottom: 2px dashed #a6d08c;
    background: #d6ffd2;
    letter-spacing: 2px;
    margin-bottom: 22px;
    padding: 10px 6px;
    text-shadow: 1px 1px 0 #fff4a3;
}

.meal-counter {
    background: #bfffa6;
    border: 2px solid #6ad64d;
    color: #397d1c;
    font-size: 1.05rem;
    font-weight: 700;
    box-shadow: 2px 2px 0 #b39a69;
    border-radius: 0;
    margin-bottom: 16px;
}

/* è¿›åº¦æ¡æ ·å¼ï¼Œåƒç´ é£è‰²å— */
.progress-title {
    font-size: 15px;
    color: #4e660f;
    text-align: left;
    margin-bottom: 12px;
    font-weight: 900;
    letter-spacing: 1px;
}
.progress-section {
    margin: 20px 0 8px 0;
    padding: 10px 4px 10px 4px;
    background: #c1eab8;
    border: 2.5px solid #639643;
    box-shadow: 4px 4px 0 #b39a69;
    border-radius: 0;
}
.progress-item {
    margin-bottom: 13px;
}
.progress-label {
    display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 14px;
    color: #639643; font-weight: 700; letter-spacing: 1px;
}
.progress-bar {
    background: #7fc4c6;
    border: 2px solid #397d1c;
    border-radius: 0;
    height: 18px;
    box-shadow: 2px 2px 0 #b39a69;
    position: relative;
    overflow: visible;
}
.progress-fill {
    height: 100%;
    border-radius: 0;
    transition: width 0.8s;
    position: relative;
}
.progress-fill.calories { background: linear-gradient(90deg, #cfff49, #b5dca6); }
.progress-fill.protein { background: linear-gradient(90deg, #8bff91, #41b348); }
.progress-fill.carbs { background: linear-gradient(90deg, #ffe082, #fff4a3); }
.progress-fill.fat { background: linear-gradient(90deg, #ffd180, #b77a4c); }
.progress-fill.fiber { background: linear-gradient(90deg, #64b5f6, #bae1ff); }
.progress-overflow {
    position: absolute; top: 0; left:0; height: 100%; width:100%;
    background: repeating-linear-gradient(45deg,rgba(244,67,54,0.3),rgba(244,67,54,0.3) 6px,rgba(244,67,54,0.1) 6px,rgba(244,67,54,0.1) 12px);
    animation: overflow-pulse 2s infinite;
}
@keyframes overflow-pulse { 0%,100%{opacity:0.6;} 50%{opacity:1;} }

.daily-health-score {
    background: #fff4a3;
    border: 3px solid #b39a69;
    border-radius: 0;
    margin: 15px 0;
    color: #397d1c;
    text-align: center;
    box-shadow: 2px 2px 0 #b39a69;
}
.daily-health-score-value {
    font-size: 2rem; font-weight: 900; color: #41b348;
    letter-spacing: 2px;
    text-shadow: 1px 1px 0 #fff;
}
.daily-health-score-breakdown { margin-top: 10px; font-size: 13px; color: #639643; }

.input-format-hint {
    font-size: 12px;
    color: #639643;
    margin-top: 6px;
    padding: 7px;
    background: #fffde9;
    border-radius: 0;
    border-left: 4px solid #b39a69;
}

.form-group label {
    font-size: 15px; color: #639643; font-weight: 600; margin-bottom: 7px;
}
.form-group {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}
.form-group label {
    width: 100px;
    min-width: 70px;
    margin-right: 16px;
    text-align: right;
    flex-shrink: 0;
}
.form-group input,
.form-group select,
.form-group textarea {
    flex: 1 1 auto;
    width: 100%;
    min-width: 0;
    max-width: 100%;
}

.log-entry, .recommendation-item, .nutrition-accuracy-info {
    background: #d6ffd2;
    border: 2px solid #639643;
    border-radius: 0;
    margin: 5px 0;
    color: #397d1c;
    font-size: 13px;
    box-shadow: 2px 2px 0 #b39a69;
}

.hidden { display: none !important; }
.main-page {
    width: 100%;
    max-width: 1400px;
    min-width: 320px;
    margin: 2.5vh auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box;
    padding: 0 min(2vw, 20px);
}
.nav-content { 
    display: none; 
    position: absolute;
    z-index: 1000;
    -webkit-transform: translateZ(0); /* iOSç¡¬ä»¶åŠ é€Ÿ */
    transform: translateZ(0);
}

.nav-dropdown.active .nav-content { 
    display: block !important; /* å¼ºåˆ¶æ˜¾ç¤ºï¼ŒiOSå…¼å®¹ */
}

/* iOS Safariä¸“ç”¨ä¼˜åŒ– */
.icon-btn {
    -webkit-tap-highlight-color: transparent; /* ç§»é™¤iOSç‚¹å‡»é«˜äº® */
    -webkit-touch-callout: none; /* ç¦ç”¨iOSé•¿æŒ‰èœå• */
    -webkit-user-select: none;
    user-select: none;
}

/* æ¡Œé¢ç«¯ä¿ç•™æ‚¬åœæ•ˆæœ */
@media (hover: hover) and (pointer: fine) {
    .nav-dropdown:hover .nav-content { 
        display: block; 
    }
}

/* ç§»åŠ¨ç«¯ç¦ç”¨æ‚¬åœæ•ˆæœ */
@media (hover: none) and (pointer: coarse) {
    .nav-dropdown:hover .nav-content { 
        display: none; 
    }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .interface {
        padding: 20px 16px 16px 16px;
        margin-bottom: 16px;
    }
    
    .app-header {
        padding: 8px 16px;
    }
    
    .title {
        font-size: 1.5rem;
    }
    
    .main-page {
        padding: 0 10px;
        gap: 16px;
    }
    
    .form-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .form-group label {
        text-align: left;
        margin-bottom: 8px;
        width: 100%;
    }
    
    input, select, textarea {
        min-width: auto;
        width: 100%;
    }

@media (max-width: 480px) {
    .interface {
        padding: 16px 12px;
    }
    
    .title {
        font-size: 1.2rem;
        letter-spacing: 1px;
    }
    
    .interface-title {
        font-size: 1rem;
        padding: 8px 4px;
        margin-bottom: 16px;
    }
    
    .progress-section {
        padding: 8px 4px;
    }
}

    </style>
</head>
<body>
<div class="app-header" style="display:flex;align-items:center;justify-content:space-between;position:relative;margin-bottom:20px;">
  <div class="title" style="font-size:2rem;font-weight:600;color:#64b5f6;letter-spacing:2px;">Trii 4.5</div>
  <div class="header-buttons" style="display:flex;gap:10px;align-items:center;">
    <div class="nav-dropdown" style="position:relative;">
<button class="icon-btn" id="navMenuBtn" title="èœå•">â˜°</button>
      <div class="nav-content" style="right:0;left:auto;top:42px;">
        <a href="javascript:void(0);" onclick="switchToMainPage()">ä¸»é¡µ</a>
        <a href="javascript:void(0);" onclick="switchToDataPage()">æ•°æ®é¡µ</a>
        <a href="javascript:void(0);" onclick="resetApp()">é‡ç½®</a>
      </div>
    </div>
  </div>
</div>
<div class="main-page" id="mainPage">
  <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼ˆé¦–æ¬¡è¿›å…¥æ‰æ˜¾ç¤ºï¼Œåç»­éšè—ï¼‰ -->
  <div class="interface interface-a" id="personalInfoArea">
      <div class="interface-title">ğŸ“± ç”¨æˆ·ä¿¡æ¯ä¸è¥å…»è®¡åˆ’</div>
      <div id="personalInfo">
        <div class="form-group">
            <label>ğŸ‘¤ æ€§åˆ«</label>
            <select id="gender">
                <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
                <option value="male">ğŸ‘¨ ç”·æ€§</option>
                <option value="female">ğŸ‘© å¥³æ€§</option>
            </select>
        </div>
        <div class="form-group">
            <label>ğŸ“ èº«é«˜ (cm)</label>
            <input type="number" id="height" placeholder="è¯·è¾“å…¥èº«é«˜ï¼Œå¦‚175" min="100" max="250">
        </div>
        <div class="form-group">
            <label>âš–ï¸ ä½“é‡ (kg)</label>
            <input type="number" id="weight" placeholder="è¯·è¾“å…¥ä½“é‡ï¼Œå¦‚70" min="30" max="300">
        </div>
        <div class="form-group">
            <label>ğŸ‚ å¹´é¾„</label>
            <input type="number" id="age" placeholder="è¯·è¾“å…¥å¹´é¾„ï¼Œå¦‚28" min="16" max="100">
        </div>
        <div class="form-group">
            <label>ğŸ¯ å¥åº·ç›®æ ‡</label>
            <select id="goal">
                <option value="">è¯·é€‰æ‹©æ‚¨çš„ç›®æ ‡</option>
                <option value="lose">ğŸ”¥ å‡è„‚ç˜¦èº«</option>
                <option value="gain">ğŸ’ª å¢è‚Œå¡‘å½¢</option>
                <option value="balance">âš–ï¸ å¹³è¡¡è¥å…»</option>
            </select>
        </div>
        <button class="btn" onclick="submitPersonalInfo()">ç”Ÿæˆä¸ªæ€§åŒ–è¥å…»è®¡åˆ’</button>
      </div>
  </div>

  <!-- å½•å…¥åŒºåŸŸï¼Œä¿¡æ¯å½•å…¥åå¸¸é©»ä¸Šæ–¹ -->
  <div class="interface" id="mealInputArea" style="margin-top:0; display:none;">
  <div class="interface-title">Nutrition Tracker</div>   
    <div id="mealInput">
        <div class="meal-counter">
            ä»Šæ—¥ç¬¬ <span id="mealNumber">1</span> é¤ï¼ˆå»ºè®®æ¯æ—¥2-5é¤ï¼‰
        </div>
      <div class="form-group">
    <label>è¾“å…¥ï¼š</label>
    <textarea id="mealInputRaw" placeholder="å¦‚ï¼š20250527-0830-32-ä¸¤ä¸ªåŒ…å­ï¼Œç‚’çŒªè‚‰200gï¼Œè‰è“80g" rows="2"></textarea>
</div>
        <button class="btn" onclick="submitMeal()">å½•å…¥æœ¬é¤æ•°æ®</button>
    </div>
    <div id="mealFeedback" style="margin-top:16px;"></div>
  </div>

  <!-- è¿›åº¦æ¡ä¸å¥åº·åˆ†åŒºåŸŸï¼Œå®æ—¶åé¦ˆ -->
  <div class="interface" id="progressHealthArea" style="margin-top:0; padding-top:0; display:none;">
<div id="progressSection" class="progress-section">
    <div class="progress-title">è¥å…»è¾¾æˆè¿›åº¦</div>
    <div class="progress-item">
        <div class="progress-label">
            <span>å¡è·¯é‡Œ</span>
            <span id="progressCaloriesValue"></span>
        </div>
        <div class="progress-bar"><div class="progress-fill calories" id="progressCalories"></div></div>
    </div>
    <div class="progress-item">
        <div class="progress-label">
            <span>è›‹ç™½è´¨</span>
            <span id="progressProteinValue"></span>
        </div>
        <div class="progress-bar"><div class="progress-fill protein" id="progressProtein"></div></div>
    </div>
    <div class="progress-item">
        <div class="progress-label">
            <span>ç¢³æ°´</span>
            <span id="progressCarbsValue"></span>
        </div>
        <div class="progress-bar"><div class="progress-fill carbs" id="progressCarbs"></div></div>
    </div>
    <div class="progress-item">
        <div class="progress-label">
            <span>è„‚è‚ª</span>
            <span id="progressFatValue"></span>
        </div>
        <div class="progress-bar"><div class="progress-fill fat" id="progressFat"></div></div>
    </div>
    <div class="progress-item">
        <div class="progress-label">
            <span>è†³é£Ÿçº¤ç»´</span>
            <span id="progressFiberValue"></span>
        </div>
        <div class="progress-bar"><div class="progress-fill fiber" id="progressFiber"></div></div>
    </div>
</div> 
    <div class="daily-health-score" id="dailyHealthScore" style="display:none;">
        <div>ä»Šæ—¥å¥åº·è¯„åˆ†</div>
        <div class="daily-health-score-value" id="healthScoreValue">-</div>
        <div class="daily-health-score-breakdown" id="healthScoreBreakdown"></div>
    </div>
  </div>
</div>

    <!-- æ•°æ®åˆ†æé¡µé¢ -->
    <div class="data-page" id="dataPage" style="display: none;">
        <div class="interface interface-c">
            <div class="interface-title">ğŸ“Š è¥å…»æ•°æ®åˆ†æä¸å¥åº·è¶‹åŠ¿</div>
            <div id="progressSectionData" class="progress-section">
            <div class="progress-title">è¥å…»è¾¾æˆè¿›åº¦</div>
            <div class="progress-item">
                <div class="progress-label">
                    <span>å¡è·¯é‡Œ</span>
                    <span id="progressCaloriesValueData"></span>
                </div>
                <div class="progress-bar"><div class="progress-fill calories" id="progressCaloriesData"></div></div>
            </div>
            <div class="progress-item">
                <div class="progress-label">
                    <span>è›‹ç™½è´¨</span>
                    <span id="progressProteinValueData"></span>
                </div>
                <div class="progress-bar"><div class="progress-fill protein" id="progressProteinData"></div></div>
            </div>
            <div class="progress-item">
                <div class="progress-label">
                    <span>ç¢³æ°´</span>
                    <span id="progressCarbsValueData"></span>
                </div>
                <div class="progress-bar"><div class="progress-fill carbs" id="progressCarbsData"></div></div>
            </div>
            <div class="progress-item">
                <div class="progress-label">
                    <span>è„‚è‚ª</span>
                    <span id="progressFatValueData"></span>
                </div>
                <div class="progress-bar"><div class="progress-fill fat" id="progressFatData"></div></div>
            </div>
            <div class="progress-item">
                <div class="progress-label">
                    <span>è†³é£Ÿçº¤ç»´</span>
                    <span id="progressFiberValueData"></span>
                </div>
                <div class="progress-bar"><div class="progress-fill fiber" id="progressFiberData"></div></div>
            </div>
        </div>
                    <div class="progress-bar"><div class="progress-fill calories" id="progressCalories"></div></div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>è›‹ç™½è´¨</span>
                        <span id="progressProteinValue"></span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill protein" id="progressProtein"></div></div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>ç¢³æ°´</span>
                        <span id="progressCarbsValue"></span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill carbs" id="progressCarbs"></div></div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>è„‚è‚ª</span>
                        <span id="progressFatValue"></span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill fat" id="progressFat"></div></div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>è†³é£Ÿçº¤ç»´</span>
                        <span id="progressFiberValue"></span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill fiber" id="progressFiber"></div></div>
                </div>
            </div>
<div class="daily-health-score" id="dailyHealthScoreData">
    <div>ä»Šæ—¥å¥åº·è¯„åˆ†</div>
    <div class="daily-health-score-value" id="healthScoreValueData">-</div>
    <div class="daily-health-score-breakdown" id="healthScoreBreakdownData"></div>
</div>
            </div>
            <div class="nutrition-accuracy-info" id="nutritionAccuracyInfo" style="display:none;">
                <div>è¥å…»æ•°æ®å‡†ç¡®æ€§ <span id="accuracyDetails"></span></div>
            </div>
<div class="user-info-section" id="userInfoSection" style="margin-top:20px;margin-bottom:20px;background:#d6ffd2;border:2px solid #639643;border-radius:0;padding:15px;box-shadow:2px 2px 0 #b39a69;">
    <div style="font-size:16px;color:#397d1c;font-weight:700;margin-bottom:10px;">ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯ä¸è¥å…»è®¡åˆ’</div>
    <div id="userInfoContent"></div>
</div>

<div class="meal-records-section" id="mealRecordsSection" style="margin-top:20px;margin-bottom:20px;background:#d6ffd2;border:2px solid #639643;border-radius:0;padding:15px;box-shadow:2px 2px 0 #b39a69;">
    <div style="font-size:16px;color:#397d1c;font-weight:700;margin-bottom:10px;">ğŸ½ï¸ é¥®é£Ÿè®°å½•è¯¦æƒ…</div>
    <div id="mealRecordsContent" style="max-height:300px;overflow:auto;"></div>
</div>
            <div style="margin:20px 0;">
                <div class="chart-title">æ¯æ—¥åˆ†æ•°è¶‹åŠ¿</div>
                <canvas id="scoreTrend" width="800" height="180" style="width:100%;max-width:800px;background:rgba(40,50,80,0.15);border-radius:4px;display:none;"></canvas>
            </div>
            <div>
                <div style="font-size:14px;color:#64b5f6;margin-bottom:8px;">é¤é£Ÿåˆ†ææ—¥å¿—</div>
                <div id="analysisLog" style="max-height:180px;overflow:auto;background:rgba(20,30,40,0.4);border-radius:4px;padding:10px;"></div>
            </div>
        </div>
    </div>
</body>
<script>
// === USDAå…¨é‡é£Ÿç‰©æ•°æ®åº“ç»“æ„ç¤ºä¾‹ï¼ˆè¯·ç”¨å®Œæ•´æ•°æ®æ›¿æ¢...ï¼‰===
const foodDatabase = {
    // === æ°´æœç±»ï¼ˆåŸºäºUSDAæ•°æ®ï¼‰===
    'é¦™è•‰': { 
        calories: 89, protein: 1.1, carbs: 22.8, fat: 0.3, fiber: 2.6, processing: 1,
        vitaminA: 3, vitaminC: 8.7, vitaminE: 0.10, vitaminB1: 0.03, vitaminB2: 0.07, vitaminB6: 0.37, folate: 20,
        calcium: 5, iron: 0.26, magnesium: 27, phosphorus: 22, potassium: 358, sodium: 1, zinc: 0.15
    },
    'è‹¹æœ': { 
        calories: 52, protein: 0.3, carbs: 13.8, fat: 0.2, fiber: 2.4, processing: 1,
        vitaminA: 3, vitaminC: 4.6, vitaminE: 0.18, vitaminB1: 0.02, vitaminB2: 0.03, vitaminB6: 0.04, folate: 3,
        calcium: 6, iron: 0.12, magnesium: 5, phosphorus: 11, potassium: 107, sodium: 1, zinc: 0.04
    },
    'æ©™å­': { 
        calories: 47, protein: 0.9, carbs: 11.8, fat: 0.1, fiber: 2.4, processing: 1,
        vitaminA: 11, vitaminC: 53.2, vitaminE: 0.18, vitaminB1: 0.09, vitaminB2: 0.04, vitaminB6: 0.06, folate: 40,
        calcium: 40, iron: 0.10, magnesium: 10, phosphorus: 14, potassium: 181, sodium: 0, zinc: 0.07
    },
    'æ¢¨': { 
        calories: 57, protein: 0.4, carbs: 15.2, fat: 0.1, fiber: 3.1, processing: 1,
        vitaminA: 1, vitaminC: 4.3, vitaminE: 0.12, vitaminB1: 0.01, vitaminB2: 0.03, vitaminB6: 0.03, folate: 7,
        calcium: 9, iron: 0.18, magnesium: 7, phosphorus: 12, potassium: 116, sodium: 1, zinc: 0.10
    },
    'è‘¡è„': { 
        calories: 67, protein: 0.6, carbs: 17.2, fat: 0.2, fiber: 0.9, processing: 1,
        vitaminA: 3, vitaminC: 10.8, vitaminE: 0.19, vitaminB1: 0.07, vitaminB2: 0.07, vitaminB6: 0.09, folate: 2,
        calcium: 10, iron: 0.36, magnesium: 7, phosphorus: 20, potassium: 191, sodium: 3, zinc: 0.07
    },
    'è¥¿ç“œ': { 
        calories: 30, protein: 0.6, carbs: 7.6, fat: 0.2, fiber: 0.4, processing: 1,
        vitaminA: 28, vitaminC: 8.1, vitaminE: 0.05, vitaminB1: 0.03, vitaminB2: 0.02, vitaminB6: 0.05, folate: 3,
        calcium: 7, iron: 0.24, magnesium: 10, phosphorus: 11, potassium: 112, sodium: 1, zinc: 0.10
    },
    'è‰è“': { 
        calories: 32, protein: 0.7, carbs: 7.7, fat: 0.3, fiber: 2.0, processing: 1,
        vitaminA: 1, vitaminC: 58.8, vitaminE: 0.29, vitaminB1: 0.02, vitaminB2: 0.02, vitaminB6: 0.05, folate: 24,
        calcium: 16, iron: 0.41, magnesium: 13, phosphorus: 24, potassium: 153, sodium: 1, zinc: 0.14
    },
    'è è': { 
        calories: 50, protein: 0.5, carbs: 13.1, fat: 0.1, fiber: 1.4, processing: 1,
        vitaminA: 3, vitaminC: 47.8, vitaminE: 0.02, vitaminB1: 0.08, vitaminB2: 0.03, vitaminB6: 0.11, folate: 18,
        calcium: 13, iron: 0.29, magnesium: 12, phosphorus: 8, potassium: 109, sodium: 1, zinc: 0.12
    },
    'çŒ•çŒ´æ¡ƒ': { 
        calories: 61, protein: 1.1, carbs: 14.7, fat: 0.5, fiber: 3.0, processing: 1,
        vitaminA: 4, vitaminC: 92.7, vitaminE: 1.46, vitaminB1: 0.03, vitaminB2: 0.02, vitaminB6: 0.06, folate: 25,
        calcium: 34, iron: 0.31, magnesium: 17, phosphorus: 34, potassium: 312, sodium: 3, zinc: 0.14
    },
    'æŸšå­': { 
        calories: 32, protein: 0.6, carbs: 8.1, fat: 0.1, fiber: 1.0, processing: 1,
        vitaminA: 1, vitaminC: 61, vitaminE: 0.24, vitaminB1: 0.04, vitaminB2: 0.03, vitaminB6: 0.04, folate: 8,
        calcium: 12, iron: 0.11, magnesium: 8, phosphorus: 8, potassium: 135, sodium: 1, zinc: 0.04
    },
    'æŸ æª¬': { 
        calories: 29, protein: 1.1, carbs: 9.3, fat: 0.3, fiber: 2.8, processing: 1,
        vitaminA: 1, vitaminC: 53, vitaminE: 0.15, vitaminB1: 0.04, vitaminB2: 0.02, vitaminB6: 0.08, folate: 11,
        calcium: 26, iron: 0.6, magnesium: 8, phosphorus: 16, potassium: 138, sodium: 2, zinc: 0.06
    },
    'è“è“': { 
        calories: 57, protein: 0.7, carbs: 14.5, fat: 0.3, fiber: 2.4, processing: 1,
        vitaminA: 3, vitaminC: 9.7, vitaminE: 0.57, vitaminB1: 0.04, vitaminB2: 0.04, vitaminB6: 0.05, folate: 6,
        calcium: 6, iron: 0.28, magnesium: 6, phosphorus: 12, potassium: 77, sodium: 1, zinc: 0.16
    },

    // === ä¸»é£Ÿç±» ===
    'ç±³é¥­': {
        calories: 130, protein: 2.7, carbs: 28.2, fat: 0.3, fiber: 0.4, processing: 2,
        vitaminA: 0, vitaminC: 0, vitaminE: 0.1, vitaminB1: 0.02, vitaminB2: 0.01, vitaminB6: 0.1, folate: 3,
        calcium: 10, iron: 0.2, magnesium: 12, phosphorus: 43, potassium: 35, sodium: 1, zinc: 0.5
    },
    'é¢æ¡': {
        calories: 138, protein: 4.5, carbs: 27.9, fat: 0.9, fiber: 1.4, processing: 2,
        vitaminA: 0, vitaminC: 0, vitaminE: 0.1, vitaminB1: 0.09, vitaminB2: 0.02, vitaminB6: 0.04, folate: 21,
        calcium: 15, iron: 0.5, magnesium: 18, phosphorus: 49, potassium: 44, sodium: 3, zinc: 0.7
    },
    'é¦’å¤´': {
        calories: 221, protein: 7.6, carbs: 46.7, fat: 0.5, fiber: 1.2, processing: 3,
        vitaminA: 0, vitaminC: 0, vitaminE: 0.1, vitaminB1: 0.13, vitaminB2: 0.07, vitaminB6: 0.05, folate: 44,
        calcium: 34, iron: 1.2, magnesium: 21, phosphorus: 71, potassium: 88, sodium: 5, zinc: 0.7
    },
    'å…¨éº¦é¢åŒ…': {
        calories: 247, protein: 12, carbs: 41, fat: 4.2, fiber: 7, processing: 3,
        vitaminA: 1, vitaminC: 0, vitaminE: 0.4, vitaminB1: 0.39, vitaminB2: 0.13, vitaminB6: 0.27, folate: 38,
        calcium: 107, iron: 2.5, magnesium: 90, phosphorus: 200, potassium: 250, sodium: 250, zinc: 1.5
    },
    'ç‡•éº¦ç‰‡': {
        calories: 379, protein: 13.2, carbs: 67.7, fat: 6.5, fiber: 10.1, processing: 2,
        vitaminA: 0, vitaminC: 0, vitaminE: 0.42, vitaminB1: 0.46, vitaminB2: 0.16, vitaminB6: 0.12, folate: 56,
        calcium: 54, iron: 4.7, magnesium: 177, phosphorus: 523, potassium: 429, sodium: 2, zinc: 3.1
    },
    'ç‰ç±³': {
        calories: 96, protein: 3.4, carbs: 21, fat: 1.5, fiber: 2.7, processing: 1,
        vitaminA: 9, vitaminC: 6.8, vitaminE: 0.07, vitaminB1: 0.20, vitaminB2: 0.06, vitaminB6: 0.09, folate: 46,
        calcium: 2, iron: 0.52, magnesium: 37, phosphorus: 89, potassium: 270, sodium: 15, zinc: 0.46
    },
    'çº¢è–¯': {
        calories: 86, protein: 1.6, carbs: 20.1, fat: 0.1, fiber: 3, processing: 1,
        vitaminA: 709, vitaminC: 2.4, vitaminE: 0.26, vitaminB1: 0.11, vitaminB2: 0.03, vitaminB6: 0.21, folate: 11,
        calcium: 30, iron: 0.61, magnesium: 25, phosphorus: 47, potassium: 337, sodium: 55, zinc: 0.3
    },

    // === è”¬èœç±» ===
    'è¥¿å…°èŠ±': {
        calories: 34, protein: 2.8, carbs: 6.6, fat: 0.4, fiber: 2.6, processing: 1,
        vitaminA: 31, vitaminC: 89.2, vitaminE: 0.78, vitaminB1: 0.07, vitaminB2: 0.12, vitaminB6: 0.18, folate: 63,
        calcium: 47, iron: 0.73, magnesium: 21, phosphorus: 66, potassium: 316, sodium: 33, zinc: 0.41
    },
    'è èœ': {
        calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4, fiber: 2.2, processing: 1,
        vitaminA: 469, vitaminC: 28.1, vitaminE: 2.03, vitaminB1: 0.08, vitaminB2: 0.19, vitaminB6: 0.2, folate: 194,
        calcium: 99, iron: 2.71, magnesium: 79, phosphorus: 49, potassium: 558, sodium: 79, zinc: 0.53
    },
    'èƒ¡èåœ': {
        calories: 41, protein: 0.9, carbs: 9.6, fat: 0.2, fiber: 2.8, processing: 1,
        vitaminA: 835, vitaminC: 5.9, vitaminE: 0.66, vitaminB1: 0.07, vitaminB2: 0.05, vitaminB6: 0.13, folate: 19,
        calcium: 33, iron: 0.3, magnesium: 12, phosphorus: 35, potassium: 320, sodium: 69, zinc: 0.24
    },
    'ç•ªèŒ„': {
        calories: 18, protein: 0.9, carbs: 3.9, fat: 0.2, fiber: 1.2, processing: 1,
        vitaminA: 42, vitaminC: 13.7, vitaminE: 0.54, vitaminB1: 0.04, vitaminB2: 0.02, vitaminB6: 0.08, folate: 15,
        calcium: 10, iron: 0.27, magnesium: 11, phosphorus: 24, potassium: 237, sodium: 5, zinc: 0.17
    },
    'é»„ç“œ': {
        calories: 16, protein: 0.7, carbs: 3.6, fat: 0.1, fiber: 0.5, processing: 1,
        vitaminA: 5, vitaminC: 2.8, vitaminE: 0.03, vitaminB1: 0.03, vitaminB2: 0.03, vitaminB6: 0.04, folate: 7,
        calcium: 16, iron: 0.28, magnesium: 13, phosphorus: 24, potassium: 147, sodium: 2, zinc: 0.2
    },
    'åœŸè±†': {
        calories: 77, protein: 2.0, carbs: 17.5, fat: 0.1, fiber: 2.2, processing: 1,
        vitaminA: 0, vitaminC: 19.7, vitaminE: 0.01, vitaminB1: 0.08, vitaminB2: 0.03, vitaminB6: 0.3, folate: 15,
        calcium: 12, iron: 0.81, magnesium: 23, phosphorus: 57, potassium: 429, sodium: 6, zinc: 0.3
    },
    'æ´‹è‘±': {
        calories: 40, protein: 1.1, carbs: 9.3, fat: 0.1, fiber: 1.7, processing: 1,
        vitaminA: 0, vitaminC: 7.4, vitaminE: 0.02, vitaminB1: 0.05, vitaminB2: 0.02, vitaminB6: 0.12, folate: 19,
        calcium: 23, iron: 0.21, magnesium: 10, phosphorus: 29, potassium: 146, sodium: 4, zinc: 0.17
    },
    'èŒ„å­': {
        calories: 25, protein: 1.0, carbs: 5.9, fat: 0.2, fiber: 3.0, processing: 1,
        vitaminA: 1, vitaminC: 2.2, vitaminE: 0.3, vitaminB1: 0.04, vitaminB2: 0.02, vitaminB6: 0.08, folate: 22,
        calcium: 9, iron: 0.23, magnesium: 14, phosphorus: 24, potassium: 229, sodium: 2, zinc: 0.16
    },

    // === è±†ç±»/åšæœ ===
    'é»„è±†': {
        calories: 446, protein: 36.5, carbs: 30.2, fat: 19.9, fiber: 9.3, processing: 1,
        vitaminA: 1, vitaminC: 6, vitaminE: 0.85, vitaminB1: 0.87, vitaminB2: 0.87, vitaminB6: 0.38, folate: 375,
        calcium: 277, iron: 15.7, magnesium: 280, phosphorus: 704, potassium: 1797, sodium: 2, zinc: 4.9
    },
    'è±†è…': {
        calories: 76, protein: 8.1, carbs: 1.9, fat: 4.8, fiber: 0.3, processing: 2,
        vitaminA: 25, vitaminC: 0, vitaminE: 0.01, vitaminB1: 0.07, vitaminB2: 0.06, vitaminB6: 0.06, folate: 15,
        calcium: 350, iron: 5.4, magnesium: 30, phosphorus: 97, potassium: 121, sodium: 7, zinc: 0.8
    },
    'èŠ±ç”Ÿ': {
        calories: 567, protein: 25.8, carbs: 16.1, fat: 49.2, fiber: 8.5, processing: 1,
        vitaminA: 0, vitaminC: 0, vitaminE: 8.33, vitaminB1: 0.64, vitaminB2: 0.14, vitaminB6: 0.35, folate: 240,
        calcium: 92, iron: 4.58, magnesium: 168, phosphorus: 376, potassium: 705, sodium: 18, zinc: 3.27
    },
    'æ ¸æ¡ƒ': {
        calories: 654, protein: 15.2, carbs: 13.7, fat: 65.2, fiber: 6.7, processing: 1,
        vitaminA: 20, vitaminC: 1.3, vitaminE: 0.70, vitaminB1: 0.34, vitaminB2: 0.15, vitaminB6: 0.54, folate: 98,
        calcium: 98, iron: 2.91, magnesium: 158, phosphorus: 346, potassium: 441, sodium: 2, zinc: 3.09
    },

    // === è‚‰ç±»ã€è›‹å¥¶ç±» ===
    'é¸¡èƒ¸è‚‰': {
        calories: 165, protein: 31, carbs: 0, fat: 3.6, fiber: 0, processing: 1,
        vitaminA: 13, vitaminC: 0, vitaminE: 0.27, vitaminB1: 0.07, vitaminB2: 0.05, vitaminB6: 0.64, folate: 4,
        calcium: 15, iron: 0.7, magnesium: 29, phosphorus: 220, potassium: 256, sodium: 74, zinc: 1
    },
    'çŒªé‡Œè„Š': {
        calories: 143, protein: 21.5, carbs: 0, fat: 5.4, fiber: 0, processing: 1,
        vitaminA: 4, vitaminC: 0, vitaminE: 0.2, vitaminB1: 0.93, vitaminB2: 0.23, vitaminB6: 0.59, folate: 5,
        calcium: 7, iron: 0.8, magnesium: 22, phosphorus: 228, potassium: 362, sodium: 49, zinc: 1.8
    },
    'ç‰›è‚‰': {
        calories: 187, protein: 26.1, carbs: 0, fat: 9.8, fiber: 0, processing: 1,
        vitaminA: 0, vitaminC: 0, vitaminE: 0.13, vitaminB1: 0.05, vitaminB2: 0.17, vitaminB6: 0.32, folate: 8,
        calcium: 9, iron: 2.6, magnesium: 21, phosphorus: 174, potassium: 318, sodium: 56, zinc: 4.4
    },
    'é¸¡è›‹': {
        calories: 143, protein: 13, carbs: 1.1, fat: 9.5, fiber: 0, processing: 1,
        vitaminA: 160, vitaminC: 0, vitaminE: 1.05, vitaminB1: 0.07, vitaminB2: 0.44, vitaminB6: 0.17, folate: 47,
        calcium: 56, iron: 1.75, magnesium: 12, phosphorus: 198, potassium: 138, sodium: 142, zinc: 1.3
    },
    'ç‰›å¥¶': {
        calories: 54, protein: 3.3, carbs: 5, fat: 1.6, fiber: 0, processing: 2,
        vitaminA: 46, vitaminC: 1.3, vitaminE: 0.05, vitaminB1: 0.04, vitaminB2: 0.18, vitaminB6: 0.04, folate: 5,
        calcium: 119, iron: 0.05, magnesium: 11, phosphorus: 93, potassium: 143, sodium: 44, zinc: 0.5
    },
    'é…¸å¥¶': {
        calories: 61, protein: 3.5, carbs: 4.7, fat: 3.3, fiber: 0, processing: 3,
        vitaminA: 28, vitaminC: 0.8, vitaminE: 0.06, vitaminB1: 0.04, vitaminB2: 0.18, vitaminB6: 0.04, folate: 7,
        calcium: 121, iron: 0.05, magnesium: 12, phosphorus: 95, potassium: 155, sodium: 46, zinc: 0.6
    },

    // === é±¼è™¾/æ°´äº§ç±» ===
    'é²ˆé±¼': {
        calories: 97, protein: 18.4, carbs: 0, fat: 2.0, fiber: 0, processing: 1,
        vitaminA: 13, vitaminC: 1, vitaminE: 0.7, vitaminB1: 0.06, vitaminB2: 0.08, vitaminB6: 0.2, folate: 10,
        calcium: 16, iron: 0.6, magnesium: 27, phosphorus: 205, potassium: 284, sodium: 51, zinc: 0.8
    },
    'ä¸‰æ–‡é±¼': {
        calories: 206, protein: 22, carbs: 0, fat: 13, fiber: 0, processing: 1,
        vitaminA: 50, vitaminC: 0, vitaminE: 2.8, vitaminB1: 0.23, vitaminB2: 0.38, vitaminB6: 0.93, folate: 25,
        calcium: 9, iron: 0.8, magnesium: 29, phosphorus: 252, potassium: 363, sodium: 50, zinc: 0.6
    },
    'å¯¹è™¾': {
        calories: 99, protein: 18.3, carbs: 0.9, fat: 1.4, fiber: 0, processing: 1,
        vitaminA: 46, vitaminC: 0, vitaminE: 1.8, vitaminB1: 0.04, vitaminB2: 0.06, vitaminB6: 0.12, folate: 19,
        calcium: 70, iron: 1.2, magnesium: 34, phosphorus: 214, potassium: 259, sodium: 148, zinc: 1.3
    },

    // === åŠ å·¥é£Ÿå“ç¤ºä¾‹ ===
    'é¦™è‚ ': {
        calories: 301, protein: 12, carbs: 2.7, fat: 27, fiber: 0, processing: 5,
        vitaminA: 17, vitaminC: 0, vitaminE: 0.24, vitaminB1: 0.69, vitaminB2: 0.19, vitaminB6: 0.17, folate: 4,
        calcium: 21, iron: 1.7, magnesium: 17, phosphorus: 102, potassium: 278, sodium: 917, zinc: 1.7
    },
    'å’¸é¸­è›‹': {
        calories: 180, protein: 10.6, carbs: 1.1, fat: 14.2, fiber: 0, processing: 4,
        vitaminA: 260, vitaminC: 0, vitaminE: 0.87, vitaminB1: 0.03, vitaminB2: 0.36, vitaminB6: 0.17, folate: 54,
        calcium: 129, iron: 3.1, magnesium: 16, phosphorus: 183, potassium: 121, sodium: 790, zinc: 1.2
    },

    // === çƒ¹é¥ªæ–¹å¼å½±å“ç³»æ•°ï¼ˆå¿…é¡»æ”¾åœ¨æœ€åï¼‰ ===
    cooking_effects: {
        stir_fry: { vitaminC_retention: 0.8, vitaminB_retention: 0.9, mineral_retention: 0.95, fat_addition: 2.5 },
        steaming: { vitaminC_retention: 0.9, vitaminB_retention: 0.95, mineral_retention: 0.98 },
        boiling: { vitaminC_retention: 0.7, vitaminB_retention: 0.8, mineral_retention: 0.85 },
        frying: { vitaminC_retention: 0.6, vitaminB_retention: 0.7, mineral_retention: 0.7, fat_addition: 8 },
        pan_frying: { vitaminC_retention: 0.8, vitaminB_retention: 0.85, mineral_retention: 0.9, fat_addition: 4 }
    }
}

// ========== çƒ¹é¥ªæ–¹å¼å¯¹è¥å…»å½±å“çš„ç®—æ³• ==========
function applyCookingEffects(originalFood, cookingMethod) {
  const modifiedFood = JSON.parse(JSON.stringify(originalFood));
  const cookingMethodMap = {
    'ç‚’': 'stir_fry', 'è’¸': 'steaming', 'æ°´ç…®': 'boiling', 'ç…®': 'boiling',
    'ç‚¸': 'frying', 'æ²¹ç‚¸': 'frying', 'ç…': 'pan_frying'
  };
  const method = cookingMethodMap[cookingMethod] || 'stir_fry';
  const effects = foodDatabase.cooking_effects[method];
  if (!effects) return modifiedFood;
  if (effects.vitaminC_retention) modifiedFood.vitaminC *= effects.vitaminC_retention;
  if (effects.vitaminB_retention) {
    modifiedFood.vitaminB1 *= effects.vitaminB_retention;
    modifiedFood.vitaminB2 *= effects.vitaminB_retention;
    modifiedFood.vitaminB6 *= effects.vitaminB_retention;
    modifiedFood.folate *= effects.vitaminB_retention;
  }
  if (effects.mineral_retention) {
    modifiedFood.calcium *= effects.mineral_retention;
    modifiedFood.iron *= effects.mineral_retention;
    modifiedFood.magnesium *= effects.mineral_retention;
    modifiedFood.phosphorus *= effects.mineral_retention;
    modifiedFood.potassium *= effects.mineral_retention;
    modifiedFood.zinc *= effects.mineral_retention;
  }
  if (effects.fat_addition) {
    modifiedFood.fat += effects.fat_addition;
    modifiedFood.calories += effects.fat_addition * 9;
  }
  if (effects.calories_addition) modifiedFood.calories += effects.calories_addition;
  if (method === 'frying') modifiedFood.processing = Math.min(5, modifiedFood.processing + 2);
  else if (method === 'stir_fry' || method === 'pan_frying') modifiedFood.processing = Math.min(5, modifiedFood.processing + 1);
  if (method === 'stir_fry' || method === 'frying' || method === 'pan_frying') modifiedFood.carbs += 1.5;
  if (method === 'frying') modifiedFood.calories = Math.round(modifiedFood.calories * 1.2);
  Object.keys(modifiedFood).forEach(key => {
    if (typeof modifiedFood[key] === 'number' && key !== 'processing') modifiedFood[key] = Math.round(modifiedFood[key] * 100) / 100;
  });
  return modifiedFood;
}
</script>
<script>
// ========== åº”ç”¨çŠ¶æ€ç®¡ç† ==========
let appState = {
    userInfo: {},
    meals: [],
    currentMeal: 1,
    currentDay: 1,
    plan: {},
    dailyNutrition: { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 },
    dailyScores: [],
    nutritionAccuracyStats: { correct: 0, total: 0, usda_matched: 0 }
};

// ========== é¡µé¢åˆ‡æ¢ ==========
function switchToMainPage() {
    document.getElementById('mainPage').style.display = 'flex';
    document.getElementById('dataPage').style.display = 'none';
}
function switchToDataPage() {
    document.getElementById('mainPage').style.display = 'none';
    document.getElementById('dataPage').style.display = 'block';
    
    // æ›´æ–°æ•°æ®é¡µå†…å®¹
    updateDataPageContent();
    
    // ç¡®ä¿æ•°æ®é¡µæ˜¾ç¤ºå‡†ç¡®æ€§ä¿¡æ¯
    const accuracyInfo = document.getElementById('nutritionAccuracyInfo');
    if (accuracyInfo) {
        accuracyInfo.style.display = 'block';
    }
    
    // æ›´æ–°å›¾è¡¨å’Œå‡†ç¡®æ€§ä¿¡æ¯
    updateDataPageCharts();
    updateAccuracyInfo();
}

// æ–°å¢å‡½æ•°ï¼šæ›´æ–°æ•°æ®é¡µå†…å®¹
function updateDataPageContent() {
    // å¤åˆ¶ä¸»é¡µçš„è¿›åº¦æ¡æ•°æ®åˆ°æ•°æ®é¡µ
    const plan = appState.plan;
    const curr = appState.dailyNutrition;
    
    // æ˜¾ç¤ºè¿›åº¦æ¡åŒºåŸŸ
    document.getElementById('progressSectionData').style.display = 'block';
    
    // æ›´æ–°è¿›åº¦æ¡æ•°å€¼
    document.getElementById('progressCaloriesValueData').textContent = `${curr.calories} / ${plan.targetCalories} kcal`;
    document.getElementById('progressProteinValueData').textContent = `${curr.protein} / ${plan.targetProtein} g`;
    document.getElementById('progressCarbsValueData').textContent = `${curr.carbs} / ${plan.targetCarbs} g`;
    document.getElementById('progressFatValueData').textContent = `${curr.fat} / ${plan.targetFat} g`;
    document.getElementById('progressFiberValueData').textContent = `${curr.fiber} / ${plan.targetFiber} g`;
    
    // æ›´æ–°è¿›åº¦æ¡
    function updateBar(id, value, max) {
        const percent = Math.min(100, Math.round((value / max) * 100));
        document.getElementById(id).style.width = percent + '%';
        if (percent > 100) {
            document.getElementById(id).classList.add('progress-overflow');
        } else {
            document.getElementById(id).classList.remove('progress-overflow');
        }
    }
    
    updateBar('progressCaloriesData', curr.calories, plan.targetCalories);
    updateBar('progressProteinData', curr.protein, plan.targetProtein);
    updateBar('progressCarbsData', curr.carbs, plan.targetCarbs);
    updateBar('progressFatData', curr.fat, plan.targetFat);
    updateBar('progressFiberData', curr.fiber, plan.targetFiber);
    
    // æ›´æ–°å¥åº·åˆ†æ•°
    if (appState.meals.length >= 3) {
        document.getElementById('dailyHealthScoreData').style.display = 'block';
        document.getElementById('healthScoreValueData').textContent = document.getElementById('healthScoreValue').textContent;
        document.getElementById('healthScoreBreakdownData').innerHTML = document.getElementById('healthScoreBreakdown').innerHTML;
    } else {
        document.getElementById('dailyHealthScoreData').style.display = 'none';
    }
    
    // æ·»åŠ ç”¨æˆ·ä¸ªäººä¿¡æ¯å’Œè¥å…»è®¡åˆ’å±•ç¤º
    renderUserInfoSection();
    
    // æ·»åŠ ç”¨æˆ·é¥®é£Ÿè®°å½•æ•°æ®å±•ç¤º
    renderMealRecordsSection();
}

function renderUserInfoSection() {
    const userInfo = appState.userInfo;
    const plan = appState.plan;
    
    if (!userInfo.gender || !plan.targetCalories) {
        document.getElementById('userInfoSection').style.display = 'none';
        return;
    }
    
    document.getElementById('userInfoSection').style.display = 'block';
    
    const goalText = userInfo.goal === 'gain' ? 'ğŸ’ª å¢è‚Œå¡‘å½¢' : userInfo.goal === 'lose' ? 'ğŸ”¥ å‡è„‚ç˜¦èº«' : 'âš–ï¸ å¹³è¡¡è¥å…»';
    
    let html = `
        <table style="width:100%;border-collapse:collapse;font-size:14px;color:#397d1c;">
            <tr>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">æ€§åˆ«ï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">${userInfo.gender === 'male' ? 'ğŸ‘¨ ç”·æ€§' : 'ğŸ‘© å¥³æ€§'}</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">å¹´é¾„ï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">${userInfo.age}å²</td>
            </tr>
            <tr>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">èº«é«˜ï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">${userInfo.height}cm</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">ä½“é‡ï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">${userInfo.weight}kg</td>
            </tr>
            <tr>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">å¥åº·ç›®æ ‡ï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;" colspan="3">${goalText}</td>
            </tr>
            <tr>
                <td colspan="4" style="padding:10px 5px 5px 5px;font-weight:700;color:#41b348;">ğŸ“‹ æ¯æ—¥è¥å…»è®¡åˆ’</td>
            </tr>
            <tr>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">åŸºç¡€ä»£è°¢ï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">${plan.bmr} kcal</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">ç›®æ ‡å¡è·¯é‡Œï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">${plan.targetCalories} kcal</td>
            </tr>
            <tr>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">è›‹ç™½è´¨ç›®æ ‡ï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">${plan.targetProtein}g</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">ç¢³æ°´ç›®æ ‡ï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">${plan.targetCarbs}g</td>
            </tr>
            <tr>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">è„‚è‚ªç›®æ ‡ï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">${plan.targetFat}g</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">è†³é£Ÿçº¤ç»´ç›®æ ‡ï¼š</td>
                <td style="padding:5px;border-bottom:1px dashed #a6d08c;">${plan.targetFiber}g</td>
            </tr>
        </table>
    `;
    
    document.getElementById('userInfoContent').innerHTML = html;
}

function renderMealRecordsSection() {
    const meals = appState.meals;
    
    if (meals.length === 0) {
        document.getElementById('mealRecordsSection').style.display = 'none';
        return;
    }
    
    document.getElementById('mealRecordsSection').style.display = 'block';
    
    let html = `
        <table style="width:100%;border-collapse:collapse;font-size:13px;color:#397d1c;">
            <tr style="background:#a6d08c;color:#2e5714;font-weight:700;">
                <th style="padding:8px;text-align:left;border:1px solid #639643;">æ—¥æœŸ</th>
                <th style="padding:8px;text-align:left;border:1px solid #639643;">æ—¶é—´</th>
                <th style="padding:8px;text-align:left;border:1px solid #639643;">æ—¶é•¿</th>
                <th style="padding:8px;text-align:left;border:1px solid #639643;">é¤é£Ÿå†…å®¹</th>
                <th style="padding:8px;text-align:left;border:1px solid #639643;">ä¸»è¦è¥å…»ç´ </th>
                <th style="padding:8px;text-align:left;border:1px solid #639643;">å¾®é‡å…ƒç´ </th>
            </tr>
    `;
    
    meals.forEach((meal, index) => {
        const date = `${meal.date.slice(0,4)}-${meal.date.slice(4,6)}-${meal.date.slice(6,8)}`;
        const time = `${meal.time.slice(0,2)}:${meal.time.slice(2,4)}`;
        
        const rowStyle = index % 2 === 0 ? 'background:#f5f5d7;' : 'background:#ffffff;';
        
        html += `
            <tr style="${rowStyle}">
                <td style="padding:8px;text-align:left;border:1px solid #639643;">${date}</td>
                <td style="padding:8px;text-align:left;border:1px solid #639643;">${time}</td>
                <td style="padding:8px;text-align:left;border:1px solid #639643;">${meal.duration}åˆ†é’Ÿ</td>
                <td style="padding:8px;text-align:left;border:1px solid #639643;">${meal.mealContent}</td>
                <td style="padding:8px;text-align:left;border:1px solid #639643;">
                    çƒ­é‡: ${meal.nutrition.calories}kcal<br>
                    è›‹ç™½è´¨: ${meal.nutrition.protein}g<br>
                    ç¢³æ°´: ${meal.nutrition.carbs}g<br>
                    è„‚è‚ª: ${meal.nutrition.fat}g<br>
                    çº¤ç»´: ${meal.nutrition.fiber}g
                </td>
                <td style="padding:8px;text-align:left;border:1px solid #639643;">
                    ç»´ç”Ÿç´ A: ${meal.nutrition.vitaminA}Î¼g<br>
                    ç»´ç”Ÿç´ C: ${meal.nutrition.vitaminC}mg<br>
                    é“: ${meal.nutrition.iron}mg<br>
                    é’™: ${meal.nutrition.calcium}mg<br>
                    é”Œ: ${meal.nutrition.zinc}mg
                </td>
            </tr>
        `;
    });
    
    html += `</table>`;
    
    document.getElementById('mealRecordsContent').innerHTML = html;
}

// ========== èœå•åˆ‡æ¢åŠŸèƒ½ (iOSå…¼å®¹å¢å¼ºç‰ˆæœ¬) ==========
let isMenuOpen = false;
let menuButton = null;
let navDropdown = null;

function toggleNavMenu() {
    console.log('Menu toggle called, current state:', isMenuOpen);
    
    if (!navDropdown) {
        navDropdown = document.querySelector('.nav-dropdown');
    }
    
    if (isMenuOpen) {
        // å…³é—­èœå•
        navDropdown.classList.remove('active');
        isMenuOpen = false;
        console.log('Menu closed');
    } else {
        // æ‰“å¼€èœå•
        navDropdown.classList.add('active');
        isMenuOpen = true;
        console.log('Menu opened');
    }
}

// å…³é—­èœå•çš„å‡½æ•°
function closeNavMenu() {
    if (!navDropdown) {
        navDropdown = document.querySelector('.nav-dropdown');
    }
    if (navDropdown) {
        navDropdown.classList.remove('active');
        isMenuOpen = false;
        console.log('Menu force closed');
    }
}

// é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®äº‹ä»¶ç›‘å¬
document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up menu events');
    
    // è·å–å…ƒç´ å¼•ç”¨
    menuButton = document.getElementById('navMenuBtn');
    navDropdown = document.querySelector('.nav-dropdown');
    
    if (menuButton && navDropdown) {
        console.log('Menu elements found');
        
        // æ¸…é™¤ç°æœ‰äº‹ä»¶
        menuButton.removeAttribute('onclick');
        
        // åˆ›å»ºç»Ÿä¸€çš„ç‚¹å‡»å¤„ç†å‡½æ•°
        function handleMenuClick(e) {
            console.log('Menu button event triggered:', e.type);
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            // å°å»¶è¿Ÿç¡®ä¿äº‹ä»¶å¤„ç†å®Œæˆ
            setTimeout(toggleNavMenu, 10);
            return false;
        }
        
        // ç»‘å®šç‚¹å‡»å’Œè§¦æ‘¸äº‹ä»¶
        menuButton.addEventListener('click', handleMenuClick, { capture: true, passive: false });
        menuButton.addEventListener('touchend', handleMenuClick, { capture: true, passive: false });
        
        // é˜²æ­¢è§¦æ‘¸å¼€å§‹æ—¶çš„é»˜è®¤è¡Œä¸º
        menuButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
        }, { passive: false });
        
    } else {
        console.error('Menu elements not found!');
    }
    
    // ç‚¹å‡»é¡µé¢å…¶ä»–ä½ç½®å…³é—­èœå•
    function handleDocumentClick(event) {
        if (!navDropdown || !menuButton) return;
        
        // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨èœå•åŒºåŸŸå¤–
        if (!navDropdown.contains(event.target) && event.target !== menuButton) {
            closeNavMenu();
        }
    }
    
    // å»¶è¿Ÿç»‘å®šæ–‡æ¡£äº‹ä»¶ï¼Œé¿å…ç«‹å³è§¦å‘
    setTimeout(function() {
        document.addEventListener('click', handleDocumentClick, { capture: true });
        document.addEventListener('touchstart', handleDocumentClick, { capture: true });
    }, 100);
    
    // èœå•é¡¹ç‚¹å‡»åå…³é—­èœå•
    setTimeout(function() {
        const navLinks = document.querySelectorAll('.nav-content a');
        console.log('Found nav links:', navLinks.length);
        
        navLinks.forEach(function(link) {
            link.addEventListener('click', function() {
                console.log('Nav link clicked');
                setTimeout(closeNavMenu, 50);
            });
            
            link.addEventListener('touchend', function() {
                console.log('Nav link touched');
                setTimeout(closeNavMenu, 50);
            });
        });
    }, 200);
});

// ========== æ—¥å¿—ä¸æ¶ˆæ¯ ==========
function addMessage(sender, message) {
    const chatArea = document.getElementById('mealFeedback');
    chatArea.innerHTML = `<div class="message ${sender}">${message}</div>`;
}
function addLogEntry(message, type = 'info') {
    const logArea = document.getElementById('analysisLog');
    const logDiv = document.createElement('div');
    logDiv.className = `log-entry ${type}`;
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML = `[${timestamp}] ${message}`;
    logArea.appendChild(logDiv);
    logArea.scrollTop = logArea.scrollHeight;
}

// ========== BMRä¸ç›®æ ‡å¡è·¯é‡Œ ==========
function calculateBMR(gender, weight, height, age) {
    let bmr;
    if (gender === 'male') {
        bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
    } else {
        bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
    }
    addLogEntry(`BMRè®¡ç®—: ${gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'}, ${weight}kg, ${height}cm, ${age}å² => ${bmr.toFixed(1)} kcal`, 'calculation');
    return bmr;
}
function calculateTargetCalories(bmr, goal) {
    const activityFactor = 1.6;
    const maintenanceCalories = bmr * activityFactor;
    let targetCalories;
    switch (goal) {
        case 'lose': targetCalories = maintenanceCalories - 500; break;
        case 'gain': targetCalories = maintenanceCalories + 300; break;
        default: targetCalories = maintenanceCalories;
    }
    addLogEntry(`ç›®æ ‡å¡è·¯é‡Œè®¡ç®—: BMR(${bmr.toFixed(1)}) * æ´»åŠ¨ç³»æ•°(${activityFactor}) = ${maintenanceCalories.toFixed(1)} => ç›®æ ‡: ${targetCalories.toFixed(1)} kcal`, 'calculation');
    return targetCalories;
}

// ========== ç”¨æˆ·ä¿¡æ¯æäº¤ ==========
function submitPersonalInfo() {
    const gender = document.getElementById('gender').value;
    const height = parseFloat(document.getElementById('height').value);
    const weight = parseFloat(document.getElementById('weight').value);
    const age = parseInt(document.getElementById('age').value);
    const goal = document.getElementById('goal').value;

    if (!gender || !height || !weight || !age || !goal) {
        alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
        return;
    }
    setTimeout(() => {
        appState.userInfo = { gender, height, weight, age, goal };
        const bmr = calculateBMR(gender, weight, height, age);
        const targetCalories = calculateTargetCalories(bmr, goal);
        const targetProtein = Math.round(weight * (goal === 'gain' ? 2.2 : goal === 'lose' ? 1.8 : 1.2));
        const targetCarbs = Math.round(targetCalories * 0.5 / 4);
        const targetFat = Math.round(targetCalories * 0.25 / 9);
        const targetFiber = Math.round(weight * 0.4);

        appState.plan = {
            bmr: Math.round(bmr),
            targetCalories: Math.round(targetCalories),
            targetProtein,
            targetCarbs,
            targetFat,
            targetFiber,
            expectedDays: 30
        };

        // æ›´æ–°ç•Œé¢
document.getElementById('personalInfoArea').style.display = 'none';
document.getElementById('mealInputArea').style.display = 'block';
document.getElementById('progressHealthArea').style.display = 'block';

        // ç›®æ ‡æ•°å€¼
        document.getElementById('targetCalories').textContent = appState.plan.targetCalories;
        document.getElementById('targetProtein').textContent = appState.plan.targetProtein;
        document.getElementById('targetCarbs').textContent = appState.plan.targetCarbs;
        document.getElementById('targetFat').textContent = appState.plan.targetFat;
        document.getElementById('targetFiber').textContent = appState.plan.targetFiber;
        document.getElementById('currentDay').textContent = appState.currentDay;

        const goalText = goal === 'gain' ? 'ğŸ’ª å¢è‚Œå¡‘å½¢' : goal === 'lose' ? 'ğŸ”¥ å‡è„‚ç˜¦èº«' : 'âš–ï¸ å¹³è¡¡è¥å…»';
        addMessage('ai', `ğŸ‰ ä¸ªäººæ¡£æ¡ˆåˆ›å»ºæˆåŠŸï¼<br><br>ğŸ“‹ <strong>æ‚¨çš„ä¸“å±è¥å…»è®¡åˆ’ï¼š</strong><br>ğŸ¯ ç›®æ ‡ï¼š${goalText}<br>ğŸ”¥ æ¯æ—¥å¡è·¯é‡Œï¼š${appState.plan.targetCalories}kcal<br>ğŸ’ª æ¯æ—¥è›‹ç™½è´¨ï¼š${targetProtein}g<br>ğŸ æ¯æ—¥ç¢³æ°´åŒ–åˆç‰©ï¼š${targetCarbs}g<br>ğŸ¥‘ æ¯æ—¥è„‚è‚ªï¼š${targetFat}g<br>ğŸŒ¾ æ¯æ—¥è†³é£Ÿçº¤ç»´ï¼š${targetFiber}g<br><br>ğŸš€ <strong>V4.4æ–°ç‰¹æ€§ï¼š</strong><br>â€¢ åŸºäºUSDA FoodData Centralæƒå¨æ•°æ®åº“<br>â€¢ 120+ç§é£Ÿç‰©ç²¾å‡†è¥å…»æˆåˆ†<br>â€¢ çƒ¹é¥ªæ–¹å¼è¥å…»å½±å“æ™ºèƒ½è®¡ç®—<br>â€¢ æ•°æ®å‡†ç¡®ç‡æå‡è‡³98%<br><br>ç°åœ¨è¯·å¼€å§‹å½•å…¥æ‚¨çš„é¤é£Ÿæ•°æ®ï¼è¯·æ³¨æ„æ ‡æ˜çƒ¹é¥ªæ–¹å¼ï¼ˆå¦‚ç‚’ã€è’¸ã€ç…®ç­‰ï¼‰ä»¥è·å¾—æ›´å‡†ç¡®çš„è¥å…»åˆ†æã€‚`);
        addLogEntry(`ç”¨æˆ·æ¡£æ¡ˆåˆå§‹åŒ–å®Œæˆ: ${gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'}, ${height}cm, ${weight}kg, ${age}å², ç›®æ ‡: ${goalText}`, 'success');
        addLogEntry(`è¥å…»è®¡åˆ’ç”Ÿæˆ: ${Math.round(targetCalories)}kcal, è›‹ç™½è´¨: ${targetProtein}g, ç¢³æ°´: ${targetCarbs}g, è„‚è‚ª: ${targetFat}g, çº¤ç»´: ${targetFiber}g`, 'success');
        updateAccuracyInfo();
    }, 1000);
}

// ========== V4.4é£Ÿç‰©æ™ºèƒ½è§£æä¸»å‡½æ•° ==========
function parseFoodInput(foodInput) {
    const nutrition = {
        calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0, processing: 0,
        vitaminA: 0, vitaminC: 0, vitaminE: 0, vitaminB1: 0, vitaminB2: 0, vitaminB6: 0, folate: 0,
        calcium: 0, iron: 0, magnesium: 0, phosphorus: 0, potassium: 0, sodium: 0, zinc: 0
    };
    const items = foodInput.split(/[ï¼Œ,ã€]/);
    let totalWeight = 0, recognizedItems = 0, totalProcessingScore = 0, micronutrientTypes = new Set(), usdaMatches = 0;
    addLogEntry(`V4.4è§£æé£Ÿç‰©è¾“å…¥: "${foodInput}"`, 'calculation');

    items.forEach(item => {
        let foodName = item.trim();
        let amount = 100;
        const match = foodName.match(/(.+?)(\d+)g?/);
        if (match) {
            foodName = match[1].trim();
            amount = parseInt(match[2]);
        } else {
            const numMatch = foodName.match(/(.*?)([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+)ä¸ª?(.+)/);
            if (numMatch) {
                const num = numMatch[2];
                const itemName = numMatch[3] || numMatch[1];
                const numValue = isNaN(parseInt(num)) ?
                    {'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5}[num] || 1 : parseInt(num);
                if (itemName.includes('åŒ…å­')) amount = numValue * 80;
                else if (itemName.includes('é¥ºå­')) amount = numValue * 25;
                else if (itemName.includes('é¸¡è›‹')) amount = numValue * 50;
                else amount = numValue * 50;
                foodName = itemName;
            }
        }
        totalWeight += amount;

        let foundFood = null, matchedKey = '', isUsdaMatch = false;
        if (foodDatabase[foodName]) {
            foundFood = foodDatabase[foodName]; matchedKey = foodName; isUsdaMatch = true;
        } else {
            const cookingMethods = ['ç‚’', 'è’¸', 'æ°´ç…®', 'ç‚¸', 'çƒ¤', 'ç…', 'ç…®'];
            let baseFoodName = foodName, cookingMethod = null;
            for (const method of cookingMethods) {
                if (foodName.includes(method)) {
                    baseFoodName = foodName.replace(method, '').trim(); cookingMethod = method; break;
                }
            }
            const possibleNames = [
                foodName, cookingMethod ? (cookingMethod + baseFoodName) : null,
                cookingMethod ? (baseFoodName + cookingMethod) : null, baseFoodName
            ].filter(Boolean);

            for (const possibleName of possibleNames) {
                if (foodDatabase[possibleName]) {
                    foundFood = foodDatabase[possibleName]; matchedKey = possibleName; isUsdaMatch = true; break;
                }
            }
            if (!foundFood) {
                for (const [key, value] of Object.entries(foodDatabase)) {
                    if (key === 'cooking_effects') continue;
                    if (baseFoodName.includes(key) || key.includes(baseFoodName)) {
                        foundFood = value; matchedKey = key;
                        if (cookingMethod && !foodName.includes(matchedKey)) {
                            foundFood = applyCookingEffects(foundFood, cookingMethod);
                            matchedKey += `(${cookingMethod}å¤„ç†)`;
                        }
                        isUsdaMatch = true; break;
                    }
                }
            }
        }

        if (foundFood) {
            const factor = amount / 100;
            nutrition.calories += foundFood.calories * factor;
            nutrition.protein += foundFood.protein * factor;
            nutrition.carbs += foundFood.carbs * factor;
            nutrition.fat += foundFood.fat * factor;
            nutrition.fiber += foundFood.fiber * factor;
            totalProcessingScore += (foundFood.processing || 1) * amount;
            nutrition.vitaminA += foundFood.vitaminA * factor;
            nutrition.vitaminC += foundFood.vitaminC * factor;
            nutrition.vitaminE += foundFood.vitaminE * factor;
            nutrition.vitaminB1 += foundFood.vitaminB1 * factor;
            nutrition.vitaminB2 += foundFood.vitaminB2 * factor;
            nutrition.vitaminB6 += foundFood.vitaminB6 * factor;
            nutrition.folate += foundFood.folate * factor;
            nutrition.calcium += foundFood.calcium * factor;
            nutrition.iron += foundFood.iron * factor;
            nutrition.magnesium += foundFood.magnesium * factor;
            nutrition.phosphorus += foundFood.phosphorus * factor;
            nutrition.potassium += foundFood.potassium * factor;
            nutrition.sodium += foundFood.sodium * factor;
            nutrition.zinc += foundFood.zinc * factor;
            const micronutrients = ['vitaminA', 'vitaminC', 'vitaminE', 'vitaminB1', 'vitaminB2', 'vitaminB6', 'folate', 'calcium', 'iron', 'magnesium', 'phosphorus', 'potassium', 'zinc'];
            micronutrients.forEach(nutrient => {
                if (foundFood[nutrient] * factor > 0.1) { micronutrientTypes.add(nutrient); }
            });
            recognizedItems++;
            if (isUsdaMatch) usdaMatches++;
            appState.nutritionAccuracyStats.correct++;
            appState.nutritionAccuracyStats.total++;
            if (isUsdaMatch) appState.nutritionAccuracyStats.usda_matched++;
            addLogEntry(`USDAåŒ¹é…æˆåŠŸ: "${foodName}" (${amount}g) => ${matchedKey} | +${(foundFood.calories * factor).toFixed(1)}kcal, è„‚è‚ª: ${(foundFood.fat * factor).toFixed(1)}g`, 'calculation');
        } else {
            appState.nutritionAccuracyStats.total++;
            addLogEntry(`é£Ÿç‰©æœªè¯†åˆ«: "${foodName}" (${amount}g) - å»ºè®®æ ‡æ˜çƒ¹é¥ªæ–¹å¼`, 'warning');
        }
    });

    nutrition.processing = totalWeight > 0 ? Math.round(totalProcessingScore / totalWeight) : 0;
    return {
        calories: Math.round(nutrition.calories),
        protein: Math.round(nutrition.protein * 10) / 10,
        carbs: Math.round(nutrition.carbs * 10) / 10,
        fat: Math.round(nutrition.fat * 10) / 10,
        fiber: Math.round(nutrition.fiber * 10) / 10,
        processing: nutrition.processing,
        recognizedItems, totalItems: items.length, usdaMatches, micronutrientCount: micronutrientTypes.size,
        vitaminA: Math.round(nutrition.vitaminA * 100) / 100,
        vitaminC: Math.round(nutrition.vitaminC * 100) / 100,
        vitaminE: Math.round(nutrition.vitaminE * 100) / 100,
        vitaminB1: Math.round(nutrition.vitaminB1 * 100) / 100,
        vitaminB2: Math.round(nutrition.vitaminB2 * 100) / 100,
        vitaminB6: Math.round(nutrition.vitaminB6 * 100) / 100,
        folate: Math.round(nutrition.folate * 100) / 100,
        calcium: Math.round(nutrition.calcium * 100) / 100,
        iron: Math.round(nutrition.iron * 100) / 100,
        magnesium: Math.round(nutrition.magnesium * 100) / 100,
        phosphorus: Math.round(nutrition.phosphorus * 100) / 100,
        potassium: Math.round(nutrition.potassium * 100) / 100,
        sodium: Math.round(nutrition.sodium * 100) / 100,
        zinc: Math.round(nutrition.zinc * 100) / 100
    };
}
window.onload = function() {
    document.getElementById('mealInputArea').style.display = 'none';
    document.getElementById('progressHealthArea').style.display = 'none';
};

</script>
<script>
// ========== é¤é£Ÿå½•å…¥æäº¤ ==========
function submitMeal() {
    const inputRaw = document.getElementById('mealInputRaw').value.trim();
    if (!inputRaw) {
        addMessage('user', 'è¯·å½•å…¥æœ¬é¤æ•°æ®ï¼');
        return;
    }
    // æ ¼å¼ï¼š20250527-0830-32-ä¸¤ä¸ªåŒ…å­ï¼Œç‚’çŒªè‚‰200gï¼Œè‰è“80g
    const match = inputRaw.match(/^(\d{8})-(\d{4})-(\d{1,3})-(.+)$/);
    if (!match) {
        addMessage('user', 'æ ¼å¼é”™è¯¯ã€‚è¯·å‚è€ƒï¼š20250527-0830-32-ä¸¤ä¸ªåŒ…å­ï¼Œç‚’çŒªè‚‰200gï¼Œè‰è“80g');
        return;
    }
    const date = match[1];
    const time = match[2];
    const duration = parseInt(match[3]);
    const mealContent = match[4];
    if (duration < 5 || duration > 120) {
        addMessage('user', 'ç”¨é¤æ—¶é•¿åº”åœ¨5~120åˆ†é’Ÿä¹‹é—´');
        return;
    }
    const nutrition = parseFoodInput(mealContent);
    appState.meals.push({
        date,        // 20250527
        time,        // 0830
        duration,    // 32
        mealContent, // ä¸¤ä¸ªåŒ…å­ï¼Œç‚’çŒªè‚‰200gï¼Œè‰è“80g
        nutrition,
        mealNumber: appState.currentMeal,
        food: mealContent
    });

    // æ›´æ–°æ¯æ—¥è¥å…»æ€»è®¡
    ['calories','protein','carbs','fat','fiber'].forEach(key=>{
        appState.dailyNutrition[key] += nutrition[key];
    });

    generateMealFeedback(appState.meals[appState.meals.length-1]);
    updateProgressBars();
    updateDailyHealthScore();
    updateAccuracyInfo();
    document.getElementById('mealNumber').textContent = ++appState.currentMeal;
    document.getElementById('mealInputRaw').value = '';
}

// ========== é¤é£Ÿåé¦ˆï¼ˆåŒ…å«çƒ¹é¥ªæ–¹å¼ä¸å»ºè®®ï¼‰ ==========
function generateMealFeedback(meal) {
    const { nutrition, mealNumber, food } = meal;
    let feedback = `ç¬¬${mealNumber}é¤åˆ†æå®Œæˆï¼`;
    // æ£€æµ‹çƒ¹é¥ªæ–¹å¼
    const cookingMethods = ['ç‚’', 'è’¸', 'ç…®', 'æ°´ç…®', 'ç‚¸', 'ç…'];
    let detectedMethod = null;
    for (const method of cookingMethods) {
        if (food.includes(method)) { detectedMethod = method; break; }
    }
    if (detectedMethod) {
        feedback += `<br><br>ğŸ” <strong>V4.4çƒ¹é¥ªæ–¹å¼å½±å“åˆ†æï¼š</strong><br>æ£€æµ‹åˆ°${detectedMethod}åˆ¶çƒ¹é¥ªæ–¹å¼`;
        if (detectedMethod === 'ç‚’') feedback += `ï¼ˆç»´ç”Ÿç´ Cä¿ç•™çº¦80%ï¼Œè„‚è‚ªå¢åŠ çº¦2.5g/100gï¼‰`;
        else if (detectedMethod === 'æ°´ç…®' || detectedMethod === 'ç…®') feedback += `ï¼ˆæ°´æº¶æ€§ç»´ç”Ÿç´ æŸå¤±çº¦25-30%ï¼Œè„‚è‚ªå«é‡åŸºæœ¬ä¸å˜ï¼‰`;
        else if (detectedMethod === 'è’¸') feedback += `ï¼ˆè¥å…»ä¿ç•™æœ€ä½³ï¼Œç»´ç”Ÿç´ æŸå¤±&lt;10%ï¼‰`;
        else if (detectedMethod === 'ç‚¸') feedback += `ï¼ˆç»´ç”Ÿç´ æŸå¤±è¾ƒå¤§ï¼Œè„‚è‚ªæ˜¾è‘—å¢åŠ çº¦8g/100gï¼‰`;
        else if (detectedMethod === 'ç…') feedback += `ï¼ˆç»´ç”Ÿç´ æŸå¤±ä¸­ç­‰ï¼Œè„‚è‚ªå¢åŠ çº¦4g/100gï¼‰`;
    }
    // åŸºäºè¥å…»æƒ…å†µç»™å‡ºè‡ªç„¶å¯¹è¯
    if (nutrition.calories > 800) feedback += `<br><br>è¿™é¤çƒ­é‡æ¯”è¾ƒé«˜ï¼Œå»ºè®®ä¸‹ä¸€é¤å¯ä»¥æ¸…æ·¡ä¸€äº›ã€‚`;
    else if (nutrition.calories < 200) feedback += `<br><br>è¿™é¤çƒ­é‡åä½ï¼Œæ³¨æ„è¥å…»è¦è·Ÿä¸Šå“¦ã€‚`;
    else feedback += `<br><br>çƒ­é‡æ§åˆ¶å¾—ä¸é”™ã€‚`;
    if (nutrition.protein > 25) feedback += ` è›‹ç™½è´¨å¾ˆå……è¶³ï¼`;
    else if (nutrition.protein < 8) feedback += ` è›‹ç™½è´¨æœ‰ç‚¹å°‘ï¼Œå»ºè®®å¢åŠ ä¸€äº›ä¼˜è´¨è›‹ç™½ã€‚`;
    if (nutrition.fiber > 8) feedback += ` è†³é£Ÿçº¤ç»´å¾ˆä¸°å¯Œï¼Œå¯¹è‚ é“å¥åº·å¾ˆæœ‰ç›Šã€‚`;
    addMessage('ai', feedback);
}

// ========== è¿›åº¦æ¡ã€å¥åº·è¯„åˆ†ã€å‡†ç¡®ç‡UI ==========
function updateProgressBars() {
    const plan = appState.plan;
    const curr = appState.dailyNutrition;
    function updateBar(id, value, max) {
        const percent = Math.min(100, Math.round((value / max) * 100));
        document.getElementById(id).style.width = percent + '%';
        if (percent > 100) {
            document.getElementById(id).classList.add('progress-overflow');
        } else {
            document.getElementById(id).classList.remove('progress-overflow');
        }
    }
    updateBar('progressCalories', curr.calories, plan.targetCalories);
    updateBar('progressProtein', curr.protein, plan.targetProtein);
    updateBar('progressCarbs', curr.carbs, plan.targetCarbs);
    updateBar('progressFat', curr.fat, plan.targetFat);
    updateBar('progressFiber', curr.fiber, plan.targetFiber);

    document.getElementById('progressCaloriesValue').textContent = `${curr.calories} / ${plan.targetCalories} kcal`;
    document.getElementById('progressProteinValue').textContent = `${curr.protein} / ${plan.targetProtein} g`;
    document.getElementById('progressCarbsValue').textContent = `${curr.carbs} / ${plan.targetCarbs} g`;
    document.getElementById('progressFatValue').textContent = `${curr.fat} / ${plan.targetFat} g`;
    document.getElementById('progressFiberValue').textContent = `${curr.fiber} / ${plan.targetFiber} g`;
}

// ========== å¥åº·è¯„åˆ†è®¡ç®— ==========
function calculateNutritionDensity(nutrition) {
    if (nutrition.calories <= 0) return 0;
    // 1. åŸºç¡€è¥å…»ç´ å¯†åº¦ (40%)
    const proteinDensity = (nutrition.protein * 4) / nutrition.calories;
    const fiberDensity = (nutrition.fiber * 2) / nutrition.calories;
    const basicDensityScore = Math.min(40, (proteinDensity + fiberDensity) * 100);
    // 2. å¾®é‡å…ƒç´ å¤šæ ·æ€§è¯„åˆ† (30%)
    const micronutrientScore = Math.min(30, nutrition.micronutrientCount * 2.5);
    // 3. ç»´ç”Ÿç´ å¯†åº¦è¯„åˆ† (20%)
    const vitaminTotal = nutrition.vitaminA/100 + nutrition.vitaminC/10 + nutrition.vitaminE/5 +
        nutrition.vitaminB1*100 + nutrition.vitaminB2*50 + nutrition.vitaminB6*25 + nutrition.folate/10;
    const vitaminDensity = Math.min(20, (vitaminTotal / nutrition.calories) * 1000);
    // 4. çŸ¿ç‰©è´¨å¯†åº¦è¯„åˆ† (10%)
    const mineralTotal = nutrition.calcium/100 + nutrition.iron*10 + nutrition.magnesium/10 +
        nutrition.phosphorus/100 + nutrition.potassium/100 + nutrition.zinc*5;
    const mineralDensity = Math.min(10, (mineralTotal / nutrition.calories) * 100);
    const totalDensityScore = basicDensityScore + micronutrientScore + vitaminDensity + mineralDensity;
    addLogEntry(`V4.4è¥å…»å¯†åº¦è®¡ç®—å®Œæˆ: åŸºç¡€${basicDensityScore.toFixed(1)}/40 + å¤šæ ·æ€§${micronutrientScore.toFixed(1)}/30 + ç»´ç”Ÿç´ ${vitaminDensity.toFixed(1)}/20 + çŸ¿ç‰©è´¨${mineralDensity.toFixed(1)}/10 = ${totalDensityScore.toFixed(1)}/100`, 'calculation');
    return Math.round(totalDensityScore * 10) / 10;
}

function updateDailyHealthScore() {
    const current = appState.dailyNutrition;
    const target = appState.plan;
    const todayMeals = appState.meals;
    if (!todayMeals.length) return;
    let totalScore = 0;
    // 1. åŸºç¡€è¥å…»æ‘„å…¥è¾¾æˆç‡ (25%)
    let nutritionScore = 0;
    const nutrients = [
        { current: current.calories, target: target.targetCalories },
        { current: current.protein, target: target.targetProtein },
        { current: current.carbs, target: target.targetCarbs },
        { current: current.fat, target: target.targetFat },
        { current: current.fiber, target: target.targetFiber }
    ];
    nutrients.forEach(nutrient => {
        const ratio = nutrient.current / nutrient.target;
        let score = 0;
        if (ratio >= 0.85 && ratio <= 1.15) score = 5;
        else if (ratio >= 0.7 && ratio <= 1.3) score = 4;
        else if (ratio >= 0.5 && ratio <= 1.5) score = 2;
        else score = 1;
        nutritionScore += score;
    });
    totalScore += nutritionScore;
    // 2. è¥å…»å¯†åº¦è¯„åˆ† (25%)
    let densityScore = 0;
    todayMeals.forEach(meal => {
        densityScore += calculateNutritionDensity(meal.nutrition);
    });
    densityScore = Math.min(25, densityScore / todayMeals.length * 0.25);
    totalScore += densityScore;
    // 3. é£Ÿç‰©åŠ å·¥ç¨‹åº¦è¯„åˆ† (15%)
    const avgProcessing = todayMeals.reduce((sum, meal) => sum + meal.nutrition.processing, 0) / todayMeals.length;
    const processingScore = Math.max(0, 15 - Math.round(avgProcessing * 3));
    totalScore += processingScore;
    // 4. è¿›é¤æ—¶é—´åŠçª—å£è¯„åˆ† (15%)
    let rhythmScore = 0;
    if (todayMeals.length >= 2) {
        const avgDuration = todayMeals.reduce((sum, meal) => sum + meal.duration, 0) / todayMeals.length;
        if (avgDuration >= 20 && avgDuration <= 40) rhythmScore += 7.5;
        else if (avgDuration >= 15 && avgDuration <= 50) rhythmScore += 5;
        else rhythmScore += 2;
        // ç”¨é¤åˆ†å¸ƒ
        rhythmScore += Math.min(7.5, todayMeals.length * 2.5);
    } else {
        rhythmScore += 3;
    }
    totalScore += rhythmScore;
    // 5. USDAæ•°æ®åŒ¹é…ç‡è¯„åˆ† (20%)
    const usdaMatchRate = appState.nutritionAccuracyStats.total > 0 ?
        (appState.nutritionAccuracyStats.usda_matched / appState.nutritionAccuracyStats.total) : 0;
    totalScore += Math.round(usdaMatchRate * 20);

    // æœ€ç»ˆå¾—åˆ†é™åˆ¶
    totalScore = Math.min(100, Math.round(totalScore));
    // æ›´æ–°UI
// ä»…åœ¨å½•å…¥3é¤åŠä»¥ä¸Šæ—¶æ‰æ˜¾ç¤ºå¥åº·åˆ†
if (appState.meals.length >= 3) {
  document.getElementById('dailyHealthScore').style.display = 'block';
} else {
  document.getElementById('dailyHealthScore').style.display = 'none';
}
    document.getElementById('healthScoreValue').textContent = totalScore;
    document.getElementById('healthScoreBreakdown').innerHTML =
        `åŸºç¡€è¾¾æˆç‡: ${nutritionScore}/25 | è¥å…»å¯†åº¦: ${densityScore.toFixed(1)}/25 | åŠ å·¥: ${processingScore}/15 | è¿›é¤èŠ‚å¾‹: ${rhythmScore.toFixed(1)}/15 | USDAåŒ¹é…: ${(usdaMatchRate*100).toFixed(1)}%`;
}

// ========== è¥å…»æ•°æ®å‡†ç¡®æ€§UI ==========
function updateAccuracyInfo() {
    const accuracyRate = appState.nutritionAccuracyStats.total > 0 ?
        Math.round((appState.nutritionAccuracyStats.correct / appState.nutritionAccuracyStats.total) * 100) : 98;
    const usdaMatchRate = appState.nutritionAccuracyStats.total > 0 ?
        Math.round((appState.nutritionAccuracyStats.usda_matched / appState.nutritionAccuracyStats.total) * 100) : 90;
    document.getElementById('accuracyDetails').innerHTML =
        `æ•°æ®åŒ¹é…ç‡: ${accuracyRate}% | USDAæ•°æ®åŒ¹é…: ${usdaMatchRate}% | å·²è¯†åˆ«é£Ÿç‰©: ${appState.nutritionAccuracyStats.correct}/${appState.nutritionAccuracyStats.total} | æ™ºèƒ½çƒ¹é¥ªæ–¹å¼æ¨æ–­å·²å¯ç”¨`;
}

// ========== æ•°æ®è¶‹åŠ¿ç­‰åŠŸèƒ½ï¼ˆæŠ˜çº¿å›¾å®ç°ï¼‰ ==========
function updateDataPageCharts() {
    // å¥åº·åˆ†è¶‹åŠ¿å›¾
    const canvas = document.getElementById('scoreTrend');
    if (!canvas || appState.meals.length < 3) {
        return; // æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®æˆ–canvaså…ƒç´ ä¸å­˜åœ¨
    }
    
    // æ˜¾ç¤ºcanvas
    canvas.style.display = 'block';
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // æ¸…é™¤ç”»å¸ƒ
    ctx.clearRect(0, 0, width, height);
    
    // ç»˜åˆ¶èƒŒæ™¯
    ctx.fillStyle = '#f5f5d7';
    ctx.fillRect(0, 0, width, height);
    
    // å‡è®¾æˆ‘ä»¬æœ‰å¥åº·åˆ†æ•°æ®
    // ç”±äºå®é™…åº”ç”¨å¯èƒ½æ²¡æœ‰å¤šå¤©æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€äº›æ•°æ®ç”¨äºå±•ç¤º
    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ‚¨éœ€è¦å­˜å‚¨æ¯å¤©çš„å¥åº·åˆ†æ•°
    let healthScores = [];
    
    // ä½¿ç”¨å½“å‰å¥åº·åˆ†ä½œä¸ºæœ€æ–°ä¸€å¤©çš„åˆ†æ•°
    const currentScore = parseInt(document.getElementById('healthScoreValue').textContent) || 0;
    
    // æ¨¡æ‹Ÿå‰å‡ å¤©çš„æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä»å­˜å‚¨ä¸­è·å–ï¼‰
    // ç”Ÿæˆ7å¤©çš„æ•°æ®ï¼Œæ¯å¤©åˆ†æ•°åœ¨å½“å‰åˆ†æ•°é™„è¿‘æ³¢åŠ¨
    for (let i = 0; i < 7; i++) {
        if (i === 6) {
            healthScores.push(currentScore); // æœ€åä¸€å¤©ä½¿ç”¨å½“å‰åˆ†æ•°
        } else {
            // æ¨¡æ‹Ÿå‰å‡ å¤©çš„æ•°æ®ï¼Œåœ¨å½“å‰åˆ†æ•°åŸºç¡€ä¸Šéšæœºæ³¢åŠ¨Â±10åˆ†
            const randomVariation = Math.floor(Math.random() * 20) - 10;
            const score = Math.max(0, Math.min(100, currentScore + randomVariation));
            healthScores.push(score);
        }
    }
    
    // ç»˜åˆ¶åæ ‡è½´
    ctx.strokeStyle = '#397d1c';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(40, 20);
    ctx.lineTo(40, height - 30);
    ctx.lineTo(width - 20, height - 30);
    ctx.stroke();
    
    // ç»˜åˆ¶æ°´å¹³åˆ»åº¦çº¿
    ctx.strokeStyle = '#a6d08c';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 10; i++) {
        const y = 20 + (height - 50) * (10 - i) / 10;
        ctx.beginPath();
        ctx.moveTo(40, y);
        ctx.lineTo(width - 20, y);
        ctx.stroke();
        
        // ç»˜åˆ¶åˆ»åº¦å€¼
        ctx.fillStyle = '#397d1c';
        ctx.font = '12px Arial';
        ctx.textAlign = 'right';
        ctx.fillText(i * 10, 35, y + 4);
    }
    
    // ç»˜åˆ¶æ•°æ®ç‚¹å’Œè¿çº¿
    if (healthScores.length > 0) {
        const dayWidth = (width - 60) / (healthScores.length - 1);
        
        // ç»˜åˆ¶è¿çº¿
        ctx.strokeStyle = '#6ad64d';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        for (let i = 0; i < healthScores.length; i++) {
            const x = 40 + i * dayWidth;
            const y = height - 30 - (healthScores[i] / 100) * (height - 50);
            
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();
        
        // ç»˜åˆ¶æ•°æ®ç‚¹
        for (let i = 0; i < healthScores.length; i++) {
            const x = 40 + i * dayWidth;
            const y = height - 30 - (healthScores[i] / 100) * (height - 50);
            
            ctx.fillStyle = '#fff4a3';
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = '#397d1c';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, Math.PI * 2);
            ctx.stroke();
            
            // æ˜¾ç¤ºåˆ†æ•°å€¼
            ctx.fillStyle = '#397d1c';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(healthScores[i], x, y - 10);
        }
        
        // ç»˜åˆ¶æ—¥æœŸæ ‡ç­¾
        ctx.fillStyle = '#397d1c';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        
        const today = new Date();
        
        for (let i = 0; i < healthScores.length; i++) {
            const x = 40 + i * dayWidth;
            const day = new Date(today);
            day.setDate(day.getDate() - (healthScores.length - 1 - i));
            
            const dateStr = `${day.getMonth() + 1}/${day.getDate()}`;
            ctx.fillText(dateStr, x, height - 10);
        }
    }
    
    // ç»˜åˆ¶å›¾è¡¨æ ‡é¢˜
    ctx.fillStyle = '#397d1c';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('æ¯æ—¥å¥åº·è¯„åˆ†è¶‹åŠ¿', width / 2, 14);
}